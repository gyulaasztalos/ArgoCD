# ArgoCD
## Homelab ArgoCD Manifests
### Introduction and Disclaimer
This repository contains Kubernetes manifests for managing my HomeLab infrastructure using GitOps principles. The goal is to deploy a high-availability K3s cluster with essential applications.

**Important Notes:**
- This setup is **not** a universal solution and should **never** be used in production environments.
- renovate bot set to automatically update all the versions to the latest!
- Security measures are implemented at a level appropriate for a HomeLab but are not the primary focus.

---

### Prerequisites
**Hardware:**
- 3 × Raspberry Pi 5 devices with:
  - 8 GB RAM
  - 256 GB NVMe SSD (primary storage)
  - Fixed IP addresses
  - Debian 12 Bookworm (latest)
- External NAS with NFS share for backups

**Notes:**
- Hosts configured via Ansible (playbook not yet included)
- HA K3s control plane nodes that also run workloads

---

### Architecture
#### Network Configuration
- **Primary IP range:** `10.0.0.0/8`
- **Server VLAN:** `10.10.50.0/24`
- **Local domain:** `local.asztalos.net`
- **Node IPs:**
  - `10.10.50.22`
  - `10.10.50.23`
  - `10.10.50.24`
- **Key Services:**
  - MetalLB range: `10.10.50.30-39`
  - Traefik LB: `10.10.50.30`
  - Pi-Hole LB: `10.10.50.31`
  - KubeVIP API: `10.10.50.20`
  - Homebridge MAC VLAN: `10.10.20.13`
- **NAS:** `unvr-pro.local.asztalos.net (10.10.50.2)`

#### Core Infrastructure
- **Base System:** Debian 12 Bookworm
- **Kubernetes:** HA K3s v1.33.1+k3s1
  - MetalLB (service load balancer)
  - KubeVIP (control plane LB)
- **GitOps:** ArgoCD
- **Storage:** HA Longhorn
- **Networking:**
  - Multus
  - Traefik (reverse proxy)
  - Cert-manager with Let's Encrypt wildcard certificates (Cloudflare DNS challenge)
- **Authentication**
  - Authentik (OIDC/OAuth 2.0 and forward auth middleware for traefik)
    - Configured with blueprints
- **Database**
  - PostgreSQL HA (CloudNativePG)
  - redis HA
- **Security:**
  - Sealed Secrets (encrypted secret storage)
  - External Secrets Operator with 1PasswordSDK provider
  - Reflector (cross-namespace secret replication)
- **Monitoring:**
  - kube-prometheus-stack
    - Prometheus, Grafana, Alertmanager
    - ServiceMonitors, PrometheusRules, and custom dashboards
- **Notifications:**
  - Apprise
  - Mailrise

#### Deployed Applications
- Rancher (use it only for read-only access or ephemeral changes)
- Nginx (testing)
- Pi-Hole + Unbound (DNS with TLS forwarding to Cloudflare DNS) + nebula-sync
- Transmission
- Flexget
- Homebridge (with multus macvlan interface)
- Paperless-NGX
- netatmo-exporter
- tado-exporter

### Bootstrap Process
1. **Host Preparation:**
    `ansible-playbook setup_environment_rpi_cluster.yml`
2. **K3s Installation:**
Follow [TechnoTim's guide](https://technotim.live/posts/k3s-etcd-ansible/)
    * `git clone https://github.com/techno-tim/k3s-ansible`

      * resources/ansible.cfg
      * resources/my-cluster
    * `ansible-playbook site.yml -i inventory/my-cluster/hosts.ini`
    * `cp kubeconfig ~/.kube/config`
3. **Traefik & Cert-Manager Setup:**
Follow [TechnoTim's guide](https://technotim.live/posts/kube-traefik-cert-manager-le/)
4. **ArgoCD Deployment:**
    * `helm repo add argo https://argoproj.github.io/argo-helm`
    * `helm repo update`
    * `helm install argocd argo/argo-cd --namespace argocd --values values.yaml`
5. **Add your git repo to ArgoCD:**
Use the WebUI or the argocd CLI tool!
6. **GitOps Bootstrap:**
`kubectl apply -f bootstrap/app-of-apps.yaml`
7. **Create EndpointSlice for the unifi-router service:**
`kubectl apply -f apps/traefik/post-install/unifi-redirect.yaml`

---

### Sealed Secrets Management
**Creating Secrets:**
1. Create the secret manifest as usual
2. `kubeseal –controller-name sealed-secrets -o yaml < pihole-secret.yaml > sealed-pihole-secret.yaml`

**Backup/Restore Master Key:**
* Backup:
`kubectl get secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key -o yaml > sealed-secrets-backup.key`
* Restore:
`kubectl apply -f sealed-secrets-backup.key`

---

### Known Issues
1. **Resource Usage:** High idle consumption. A 4th node (dedicated worker node) will be needed soon.
2. **EndpointSlices**: ArgoCD exclude handling of Endpoint and EndpointSlice manifests (for a good reason). Generally EndpointSlices are auto-generated by Kubernetes, based on the Service. However if the Service has no selector the EndpointSlice has to be created manually (outside of the GitOps workflow). This is the case for the unifi-redirect.yaml where we use traefik in the cluster to apply the wildcard certificate on an external page.
---

> **Note:** This setup evolves regularly. Check GitHub commits for latest updates.
